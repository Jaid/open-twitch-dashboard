language: node_js
node_js: [node, lts/*]
cache:
  npm: true
script:
  - npx pover install
  - npx pover build:dev
  - npx pover build:prod
  - npx pover test
jobs:
  include:
    - stage: Deploy
      if: tag =~ ^v AND branch = master
      before_deploy:
        - npm run build:prod
        - npx compile-release
      deploy:
        - provider: pages
          local_dir: page
          fqdn: $PKG_NAME.jaid.codes
          skip_cleanup: true
          github_token: $GITHUB_TOKEN # Permissions: public_repo, repo:status, repo_deployment
          on:
            condition: -d dist/page AND env(GITHUB_TOKEN) IS present
        - provider: releases
          file_glob: true
          file: dist/github/*
          skip_cleanup: true
          api_key: $GITHUB_TOKEN # Permissions: public_repo, repo:status, repo_deployment
          on:
            condition: env(GITHUB_TOKEN) IS present
        - provider: script
          script: echo "//registry.npmjs.org/:_authToken=$NPM_TOKEN" > .npmrc && npm publish dist/package/production
          skip_cleanup: true
          on:
            condition: env(NPM_TOKEN) IS present
